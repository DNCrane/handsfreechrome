<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript">
		$(function() {
			//for inputting text to forms
			var dictation_mode = false;
			//for addressing the computer abruptly, without pausing after
			//any prior speech...won't work as well as "slow" mode.
			var quick_mode = false;
			
			var valid_single_commands = [
				"map",		//paints numbers next to anchor tags
				"up",		//scrolls up 200 pixels
				"down",		//scrolls down 200 pixels
				"rise", 	//page up
				"frys", 	/*misheard word for "rise"*/
				"rice", 	/*misheard word for "rise"*/
				"fall",		//page down
				"song", 	/*misheard word for "fall"*/
				"back", 	//last page in history
				"forward",	//next page in history
				"top",		//scroll to top of page
				"bottom",	//scroll to bottom of page
				"reload",	//refresh page
				"refresh",	//refresh page
				"zoom",		//zoom in
				"enhance",	//only works in bladeRunnerMode
				"switch",	//changes to the next tab in the queue
				"exit",		//closes all Chrome windows
				"quit",		//closes all Chrome windows
				"done"		//close voice input window, i.e. close the Hands Free extension
			];
			
			var valid_double_commands = [
				"full screen",	//toggle full screen mode
				"zoom in",		//zoom in
				"zoom out", 	//zoom out WHOA WAIT WHAT DO YOU MEAN
				"new tab",		//opens a new tab
				"close tab",	//closes current tab
			];
			
			for (var i = 1; i <= 220; i++) {
				valid_single_commands.push( i.toString() );
			}

			/*Checks to see if command is valid.*/
			/*Checks against two words commands first, then against single word commands*/
			var matchesValidCommands = function(two_commands) {
				for (var i = 0; i < valid_double_commands.length; i++) {
					if (two_commands[0] + " " + two_commands[1] == valid_double_commands[i]) {
						console.log(two_commands[0] + " " + two_commands[1]);
						return 2;
					}
				}
				for (var i = 0; i < valid_single_commands.length; i++) {
					if (two_commands[0] == valid_single_commands[i]) {
						return 1;
					}
				}
				return 0;
			};
			
			//sends spoken command to extension's background script, which sends it to
			//the active tab, where it is executed by an injected control script.
			var sendCommand = function(command) {
				chrome.runtime.sendMessage('nhaknocpionlnlfomgggoahebnjllmlm', {message: command},
				function(response) {
					if (!response.success) {
						alert("failure to send message to background.js");
						console.log("failure to send message to background.js");
					}
				});
			};
			
			//handles spoken input, checking for validity and then sending it to the extension
			var receiveInput = function(input) {
				if (!dictation_mode) {
					organizedInput = input.trim().split(" ");
					non_empty_oi = [];
					for (var i = 0; i < organizedInput.length; i++) {
						if ( !(organizedInput[i].trim() === "") ) {
							non_empty_oi.push(organizedInput[i].trim());
						}
					}					
					if (!quick_mode) {
						var match = matchesValidCommands( [non_empty_oi[0], non_empty_oi[1]] );
						if ( !match ) {
							return;
						}
						else {
							if (match == 1) {
								console.log("Valid command recognized: " + non_empty_oi[0]);
								sendCommand(non_empty_oi[0]);
								return;
							}
							if (match == 2) {
								console.log("Valid command recognized: " + non_empty_oi[0] + " " + non_empty_oi[1]);
								sendCommand(non_empty_oi[0] + " " + non_empty_oi[1]);
								return;
							}
							else {
								return;
							}
						}
					}
					else {
						alert("Quick mode has not yet been implemented.");
						console.log("Quick mode has not yet been implemented.");
						return;
					}
				}
				else {
					/*
					Take input until the word "finish" is found
					send all input to background js
					
					When "finish" is found, end dictation mode,
					send "finish" to background js as independent message
					*/
					alert("Dictation mode has not yet been implemented.");
					console.log("Quick mode has not yet been implemented.");
					return;
				}
			};
			var final_transcript = '';
			var recognizing = false;
			var start = function() {
				if ('webkitSpeechRecognition' in window) {
					var recognition = new webkitSpeechRecognition();
					recognition.continuous = true;
					recognition.interimResults = true;
					recognition.lang = 'en-US';
					
					recognition.onstart = function() {
						recognizing = true;
						document.getElementById('inputDisplay').innerHTML = "Started";
					};
					
					recognition.onerror = function(event) {
						if (event.error == 'no-speech') {
						  console.log("no speech");
						  document.getElementById('inputDisplay').innerHTML = "no-speech";
						  alert("no speech, refresh");
						  //start();
						}
						if (event.error == 'audio-capture') {
						  document.getElementById('inputDisplay').innerHTML = "audio-capture";
						}
						if (event.error == 'not-allowed') {
						  alert("not-allowed-error-thing");
						}
					};
					
					recognition.onend = function() {
						console.log("recognition ended");
						recognizing = false;
						//start();
					};
					
					recognition.onresult = function(event) {
						var interim_transcript = '';
						if (typeof(event.results) == 'undefined') {
							recognition.onend = null;
							recognition.stop();
							alert("results were undefined");
							return;
						}
						for (var i = event.resultIndex; i < event.results.length; ++i) {
							if (event.results[i].isFinal) {
								final_transcript += event.results[i][0].transcript;
							} else {
								interim_transcript += event.results[i][0].transcript;
								receiveInput(event.results[i][0].transcript);
							  }
						}
						document.getElementById('inputDisplay').innerHTML = final_transcript;
						document.getElementById('interimDisplay').innerHTML = interim_transcript;
					}
					
					recognition.start();
				}
			};
			start();
		});
	</script>
</head>
<body>
	<p> 
		This is the microphone input window for the Hands Free extension for Chrome.
		If you close it by accident, it can be reopened by clicking the HandsFree icon
		in the corner of your screen.
	</p>
	<hr>
	<span id="interimDisplay">Waiting for input</span>
	<hr>
	<span id="inputDisplay">Waiting for input</span>
</body>
</html>
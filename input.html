<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript">
		$(function() {
			//for inputting text to forms
			var dictation_mode = false;
			$('#modeSwitch').click(function() {
				dictation_mode = !dictation_mode;
			});
			
			var valid_single_commands = [
				"map",		//paints numbers next to anchor tags, forms, and buttons
				"other",	//paints numbers next to spans and images
				"home",		//navigates directly to your homepage
				"att",		//misheard word for "8"
				"sex",		//misheard word for "6"
				"up",		//scrolls up 200 pixels
				"op",		//misheard word "up"
				"down",		//scrolls down 200 pixels
				"right",	//scrolls right 200 pixels
				"left",		//scrolls left 200 pixels
				"rise", 	//page up
				"frys", 	//misheard word for "rise"
				"rice", 	//misheard word for "rise"
				"fall",		//page down
				"song", 	//misheard word for "fall"
				"back", 	//last page in history
				"forward",	//next page in history
				"top",		//scroll to top of page
				"bottom",	//scroll to bottom of page
				"reload",	//refresh page
				"refresh",	//refresh page
				"zoom",		//zoom in
				"enhance",	//only works in bladeRunnerMode; removes zoom blur
				"switch",	//changes to the next tab in the queue
				"exit",		//closes all Chrome windows
				"quit",		//closes all Chrome windows
				"done",		//close help, or turn off extension
				"Don",		//misheard word for "done"
				"faster",	//increases speed of continuous scrolling
				"slower",	//decreases speed of continuous scrolling
				"flower",	//misheard word for "slower"
				"stop",		//stops continuous scrolling
				"help",		//brings up help page, or hides it
				"minimize",	//minimize main chrome windows (should deactivate extension)
			];
			
			var valid_double_commands = [
				"full screen",	//toggle full screen mode
				"zoom in",		//zoom in
				"zoom out", 	//zoom out WHOA WAIT WHAT DO YOU MEAN
				"zoom normal",	//return to standard level of zoom
				"new tab",		//opens a new tab
				"close tab"		//closes current tab				
			];
			
			var valid_triple_commands = [
				"keep scrolling down",	//sets browser scrolling continuously down until the end of the page
				"keep scrolling up",	//sets browser scrolling continuously up until the end of the page
				"keep scrolling left",	//sets browser scrolling continuously left until the end of the page
				"keep scrolling right",	//sets browser scrolling continuously right until the end of the page
				"Blade Runner mode"		//toggles zoom/enhance functionality
			];
			
			for (var i = 1; i <= 400; i++) {
				valid_single_commands.push( i.toString() );
			}

			/*Checks to see if command is valid.*/
			/*Checks against three word commands, first, then against two word commands, then against single word commands*/
			var matchesValidCommands = function(three_commands) {
				console.log("the 3 commands are:");
				console.log(three_commands);
				for (var i = 0; i < valid_triple_commands.length; i++) {
					if (three_commands[0] + " " + three_commands[1] + " " + three_commands[2] === valid_triple_commands[i] ||
						three_commands[0] + " " + three_commands[1] == "go to") {
						//this needs to be improved....it is glitching by doing "go to bestbuy" --> "go to best", "buy"
						console.log(three_commands[0] + " " + three_commands[1] + " " + three_commands[2]);
						return 3;
					}
				}
				for (var i = 0; i < valid_double_commands.length; i++) {
					if (three_commands[0] + " " + three_commands[1] === valid_double_commands[i]) {
						console.log(three_commands[0] + " " + three_commands[1]);
						return 2;
					}
				}
				for (var i = 0; i < valid_single_commands.length; i++) {
					if (three_commands[0] === valid_single_commands[i]) {
						return 1;
					}
				}
				return 0;
			};
			
			//sends spoken command to extension's background script, which sends it to
			//the active tab, where it is executed by an injected control script.
			var sendCommand = function(command) {
				chrome.runtime.sendMessage('pmefchbococjnddekdbnepkkefnaocbk', {message: command},
				function(response) {
					if (!response.success) {
						alert("failure to send message to background.js");
						console.log("failure to send message to background.js");
					}
				});
			};

			//handles spoken input, checking for validity and then sending it to the extension
			var receiveInput = function(input) {
				if (!dictation_mode) {
					organizedInput = input.trim().split(" ");
					non_empty_oi = [];
					for (var i = 0; i < organizedInput.length; i++) {
						if ( !(organizedInput[i].trim() === "") ) {
							non_empty_oi.push(organizedInput[i].trim());
						}
					}					
					var match = matchesValidCommands( [ non_empty_oi[0], non_empty_oi[1], non_empty_oi[2] ] );
					if ( !match ) {
						return;
					}
					else {
						if (match === 1) {
							console.log("Valid command recognized: " + non_empty_oi[0]);
							sendCommand(non_empty_oi[0]);
							return;
						}
						if (match === 2) {
							console.log("Valid command recognized: " + non_empty_oi[0] + " " + non_empty_oi[1]);
							sendCommand(non_empty_oi[0] + " " + non_empty_oi[1]);
							return;
						}
						if (match === 3) {
							console.log("Valid command recognized: " + non_empty_oi[0] + " " + non_empty_oi[1] + " " + non_empty_oi[2]);
							sendCommand(non_empty_oi[0] + " " + non_empty_oi[1] + " " + non_empty_oi[2]);
							return;
						}
						return;
					}
				}
				else {
					/*
					Take input until the word "done || Don || next" is found
					send all input to background js
					
					When "finish" is found, end dictation mode,
					send "finish" to background js as independent message
					*/
					
					organizedInput = input.trim().split(" ");
					non_empty_oi = [];
					for (var i = 0; i < organizedInput.length; i++) {
						if ( !(organizedInput[i].trim() === "") ) {
							non_empty_oi.push(organizedInput[i].trim());
						}
					}	
					if (non_empty_oi[non_empty_oi.length - 1] === 'next'
						|| non_empty_oi[non_empty_oi.length - 1] === 'done'
						|| non_empty_oi[non_empty_oi.length - 1] === 'Don'){
						console.log("found it");
						dictation_mode = false;
					} else {
						console.log(input);
					}
					return;
				}
			};
			var final_transcript = '';
			var recognizing = false;
			var start = function() {
				if ('webkitSpeechRecognition' in window) {
					var recognition = new webkitSpeechRecognition();
					recognition.continuous = true;
					recognition.interimResults = true;
					recognition.lang = 'en-US';
					
					recognition.onstart = function() {
						recognizing = true;
						document.getElementById('inputDisplay').innerHTML = "Started";
					};
					
					recognition.onerror = function(event) {
						if (event.error === 'no-speech') {
						  console.log("no speech");
						  document.getElementById('inputDisplay').innerHTML = "no-speech";
						  alert("no speech, refresh");
						  //start();
						}
						if (event.error === 'audio-capture') {
						  document.getElementById('inputDisplay').innerHTML = "audio-capture";
						}
						if (event.error === 'not-allowed') {
						  alert("not-allowed-error-thing");
						}
					};
					
					recognition.onend = function() {
						console.log("recognition ended");
						recognizing = false;
						//start();
					};
					
					recognition.onresult = function(event) {
						var interim_transcript = '';
						if (typeof event.results === 'undefined') {
							recognition.onend = null;
							recognition.stop();
							alert("results were undefined");
							return;
						}
						for (var i = event.resultIndex; i < event.results.length; ++i) {
							if (dictation_mode) {
								if (event.results[i].isFinal) {
									final_transcript += event.results[i][0].transcript;
									receiveInput(event.results[i][0].transcript);
								} else {
									interim_transcript += event.results[i][0].transcript;
								}
							} else {
								if (event.results[i].isFinal) {
									final_transcript += event.results[i][0].transcript;
								} else {
									interim_transcript += event.results[i][0].transcript;
									receiveInput(event.results[i][0].transcript);
								}
							}
						}
						document.getElementById('inputDisplay').innerHTML = final_transcript;
						document.getElementById('interimDisplay').innerHTML = interim_transcript;
					}
					
					recognition.start();
				}
			};
			start();
		});
	</script>
</head>
<body>
	<p> 
		This is the microphone input window for the Hands Free extension for Chrome.
		If you close it by accident, it can be reopened by clicking the HandsFree icon
		in the corner of your screen.
	</p>
	<button id='modeSwitch' style='display:none;'></button>
	<hr>
	<span id="interimDisplay">Waiting for input</span>
	<hr>
	<span id="inputDisplay">Waiting for input</span>
</body>
</html>